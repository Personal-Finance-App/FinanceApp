# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: Build and Test

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master", "develop" ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: Build with Maven
        run: mvn clean package -DskipTests
      - name: Run tests
        run: mvn test
  create_and_push_container:
     runs-on: ubuntu-latest
     needs: build_and_test
     steps:
        - uses: actions/checkout@v3
        - name: Set Maven version as environment variable
          run: echo "VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_ENV
        - name: Tag commit
          uses: mathieudutour/github-tag-action@v5
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            tag: ${{ env.VERSION }}
            message: "Version ${{ env.VERSION }}"
        - name: Convert repository name to lowercase
          run: |
            echo "::set-env name=LOWERCASE_REPO::$(echo ${GITHUB_REPOSITORY} | tr '[:upper:]' '[:lower:]')"
        
        - name: Build Docker image
          run: docker build . -t docker.pkg.github.com/${{ env.LOWERCASE_REPO }}/inance-app:${{ env.VERSION }} 

        - name: Log in to GitHub Container Registry
          run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

        - name: Push Docker image to GitHub Container Registry
          run: docker push docker.pkg.github.com/${{ env.LOWERCASE_REPO }}/finance-app:${{ env.VERSION }}

   
     
  
